@page "/en/latest/developers/driver-development"
@{
    Layout = "_ArticleLayout";
    ViewBag.Title = "Driver Development";
}

@section Styles {
    <link href="~/lib/prismjs/prism.css" rel="stylesheet" />
}

@section Scripts {
    <script src="~/lib/prismjs/prism.js"></script>
}

<nav class="doc-toc">
    <div class="h6">On this page</div>
    <hr>
    <ul>
        <li><a href="#logic">Logic Implementation</a></li>
        <li><a href="#view">Interface Implementation</a></li>
        <li><a href="#run">Run Driver</a></li>
    </ul>
</nav>

<div class="doc-content">
    <h1>Driver Development</h1>
    <p>Advantages of Rapid SCADA as a platform for driver creation:</p>
    <ul>
        <li>Communicator is responsible for the connection (Serial, TCP, UDP). The developer implements encoding and decoding of data packets.</li>
        <li>A driver can collect current, historical data and events, and send commands.</li>
        <li>The built-in OPC UA server provides data received from the developed driver to third-party OPC clients.</li>
        <li>A ready-made logging system.</li>
        <li>Unified user interface for configuration.</li>
    </ul>

    <p>Next, let's look at the development of the logical part and user interface of a simple driver, which will be named <em>DrvAbc</em>. To develop a complex driver that implements an industrial protocol, learn and use the source code of existing drivers on GitHub as examples (<a href="https://github.com/RapidScada/scada-v6/tree/master/ScadaComm/OpenDrivers" target="_blank">link 1</a>, <a href="https://github.com/RapidScada/scada-v6/tree/master/ScadaComm/OpenDrivers2" target="_blank">link 2</a>).</p>

    <h2 id="logic">Logic Implementation</h2>
    <p>Create a new project based on the <strong>Class Library</strong> template. Enter the project name <code>DrvAbc.Logic</code>, and select the .NET 8.0 framework.</p>
    <p>Add dependencies to the <code>ScadaCommon.dll</code>, <code>ScadaCommon.Log.dll</code> and <code>ScadaCommCommon.dll</code> libraries. Binary files of the libraries can be found in the Rapid SCADA installation directory, or compiled from source code.</p>
    <p>Double click a project node in <strong>Solution Explorer</strong> to open the project file <code>DrvAbc.Logic.csproj</code> and edit its properties as shown below.</p>
    <pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;TargetFramework&gt;net8.0&lt;/TargetFramework&gt;
  &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
  &lt;Nullable&gt;disable&lt;/Nullable&gt;
  &lt;RootNamespace&gt;Scada.Comm.Drivers.DrvAbc.Logic&lt;/RootNamespace&gt;
&lt;/PropertyGroup&gt;</code></pre>

    <p>Create a <code>DevAbcLogic</code> class and copy the code below. This class implements the logic for interacting with a device. Note that the namespace and class name must contain the <code>DrvAbc</code> driver code. Explore the source code of the <a href="https://github.com/RapidScada/scada-v6/blob/master/ScadaComm/ScadaComm/ScadaCommCommon/Devices/DeviceLogic.cs" target="_blank">DeviceLogic</a> base class to learn about the capabilities available when implementing device interaction logic.</p>
    <pre><code class="language-csharp">using Scada.Comm.Config;
using Scada.Comm.Devices;
using Scada.Data.Models;

namespace Scada.Comm.Drivers.DrvAbc.Logic
{
    internal class DevAbcLogic : DeviceLogic
    {
        public DevAbcLogic(ICommContext commContext, ILineContext lineContext, DeviceConfig deviceConfig)
            : base(commContext, lineContext, deviceConfig)
        {
            CanSendCommands = true;
            ConnectionRequired = false;
        }

        public override void Session()
        {
            base.Session();
            Log.WriteLine("DrvAbc driver polling session");
            FinishRequest();
            FinishSession();
        }

        public override void SendCommand(TeleCommand cmd)
        {
            base.SendCommand(cmd);
            Log.WriteLine("Command value = {0}", cmd.CmdVal);
            FinishCommand();
        }
    }
}</code></pre>

    <p>Создайте класс <code>DrvAbcLogic</code>, код которого показан ниже. Этот класс реализует общую логику драйвера, не связанную с конкретным устройством. Изучите исходный код базового класса <a href="https://github.com/RapidScada/scada-v6/blob/master/ScadaComm/ScadaComm/ScadaCommCommon/Drivers/DriverLogic.cs" target="_blank">DriverLogic</a>, чтобы узнать о доступных возможностях.</p>
    <pre><code class="language-csharp">using Scada.Comm.Config;
using Scada.Comm.Devices;

namespace Scada.Comm.Drivers.DrvAbc.Logic
{
    public class DrvAbcLogic : DriverLogic
    {
        public DrvAbcLogic(ICommContext commContext)
            : base(commContext)
        {
        }

        public override string Code =&gt; "DrvAbc";

        public override DeviceLogic CreateDevice(ILineContext lineContext, DeviceConfig deviceConfig)
        {
            return new DevAbcLogic(CommContext, lineContext, deviceConfig);
        }
    }
}</code></pre>

    <p>Пример логической части драйвера готов. Выполните сборку проекта и скопируйте <code>DrvAbc.Logic.dll</code> в директорию драйверов Коммуникатора <code>ScadaComm\Drv</code></p>

    <h2 id="view">Interface Implementation</h2>
    <p>Создайте новый проект на основе шаблона <strong>Windows Forms Class Library</strong>. Введите наименование проекта <code>DrvAbc.View</code>, выберите фреймворк .NET 8.0.</p>
    <p>Добавьте зависимости на библиотеки <code>ScadaCommon.dll</code>, <code>ScadaCommon.Forms.dll</code>, <code>ScadaCommon.Log.dll</code> и <code>ScadaCommCommon.dll</code>.</p>
    <p>По двойному щелчку в <strong>Solution Explorer</strong> откройте файл проекта <code>DrvAbc.View.csproj</code> и отредактируйте его свойства, как показано ниже.</p>
    <pre><code class="language-xml">&lt;PropertyGroup&gt;
  &lt;TargetFramework&gt;net8.0-windows&lt;/TargetFramework&gt;
  &lt;Nullable&gt;disable&lt;/Nullable&gt;
  &lt;UseWindowsForms&gt;true&lt;/UseWindowsForms&gt;
  &lt;ImplicitUsings&gt;enable&lt;/ImplicitUsings&gt;
  &lt;RootNamespace&gt;Scada.Comm.Drivers.DrvAbc.View&lt;/RootNamespace&gt;
&lt;/PropertyGroup&gt;</code></pre>

    <p>Создайте класс <code>DevAbcView</code> и скопируйте код, который приведён ниже. Этот класс реализует пользовательский интерфейс для настройки параметров взаимодействия с устройством. Обратите внимание, что пространство имён и имя класса должны содержать код драйвера <code>DrvAbc</code>. В нашем примере пользовательский интерфейс драйвера фактически отсутствует, тем не менее необходима минимальная реализация интерфейса, чтобы драйвер можно было использовать в приложении Администратор. Изучите исходный код базового класса <a href="https://github.com/RapidScada/scada-v6/blob/master/ScadaComm/ScadaComm/ScadaCommCommon/Devices/DeviceView.cs" target="_blank">DeviceView</a>, чтобы узнать о доступных возможностях.</p>
    <pre><code class="language-csharp">using Scada.Comm.Config;
using Scada.Comm.Devices;

namespace Scada.Comm.Drivers.DrvAbc.View
{
    internal class DevAbcView : DeviceView
    {
        public DevAbcView(DriverView parentView, LineConfig lineConfig, DeviceConfig deviceConfig)
            : base(parentView, lineConfig, deviceConfig)
        {
        }
    }
}</code></pre>

    <p>Создайте класс <code>DrvAbcView</code>, код которого показан ниже. Этот класс реализует общий пользовательский интерфейс драйвера, не связанный с конкретным устройством. Изучите исходный код базового класса <a href="https://github.com/RapidScada/scada-v6/blob/master/ScadaComm/ScadaComm/ScadaCommCommon/Drivers/DriverView.cs" target="_blank">DriverView</a>, чтобы узнать о доступных возможностях.</p>
    <pre><code class="language-csharp">using Scada.Comm.Config;
using Scada.Comm.Devices;

namespace Scada.Comm.Drivers.DrvAbc.View
{
    public class DrvAbcView : DriverView
    {
        public DrvAbcView()
            : base()
        {
            CanCreateDevice = true;
        }

        public override string Name =&gt; "ABC Driver";

        public override string Descr =&gt; "Simple driver example";

        public override DeviceView CreateDeviceView(LineConfig lineConfig, DeviceConfig deviceConfig)
        {
            return new DevAbcView(this, lineConfig, deviceConfig);
        }
    }
}</code></pre>

    <p>Пример части драйвера, отвечающей за пользовательский интерфейс, готов. Выполните сборку проекта и скопируйте <code>DrvAbc.View.dll</code> в директорию библиотек Администратора <code>ScadaAdmin\Lib</code></p>

    <h2 id="run">Run Driver</h2>
    <p>Запустите приложение Администратор или перезапустите его, если оно было открыто. Создайте новый проект и в разделе <strong>Коммуникатор &gt; Драйверы</strong> найдите разработанный драйвер. Убедитесь, что при выборе драйвера его описание корректно отображается. Если при отображении описания драйвера возникла ошибка, скорее всего, допущена неточность в пространстве имён или именах классов интерфейса драйвера.</p>
    <p>Создайте линию связи и добавьте устройство, использующее драйвер <em>DrvAbc</em>, на линию. Запустите проект. В журнале линии связи можно наблюдать информацию о работе созданного драйвера:</p>
    <pre><code>2024-04-18 13:15:41 Session with the device [3] ABC
DrvAbc driver polling session</code></pre>
</div>
