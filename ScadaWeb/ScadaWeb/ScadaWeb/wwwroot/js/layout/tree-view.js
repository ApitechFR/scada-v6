// Implements behavior of a tree view generated by TreeViewRenderer.
// Depends on jquery.
class TreeView {
    constructor(elemID) {
        this.treeViewElem = $("#" + elemID);
    }

    #expandSelectedNodes(allNodes) {
        let selectedNodes = allNodes.filter(".selected");
        let parentElems = selectedNodes.parentsUntil(".tree-view", ".child-nodes");

        parentElems.prev(".node").find(".expander").addClass("expanded");
        parentElems.removeClass("hidden");
    }

    #clickNode(node) {
        let thisObj = this;
        let script = node.data("script");
        let expander = node.find(".expander");
        let href = node.attr("href");

        if ($(event.target).is(".expander")) {
            thisObj.#toggleNode(node, expander);
        } else if (script) {
            allNodes.removeClass("selected");
            clickedNode.addClass("selected");
            eval(script); // execute script
        } else if (href.length > 0) {
            allNodes.removeClass("selected");
            clickedNode.addClass("selected");
            location.href = href; // navigate link
        } else if (!expander.hasClass("empty")) {
            thisObj.#toggleNode(node, expander);
        }
    }

    #toggleNode(node, expander) {
        let childNodes = node.next(".child-nodes");

        if (expander.hasClass("expanded")) {
            expander.removeClass("expanded");
            childNodes.addClass("hidden");
        } else {
            expander.addClass("expanded");
            childNodes.removeClass("hidden");
        }
    }

    prepare() {
        let allNodes = this.treeViewElem.find(".node");

        // set node indents according to their levels
        let indentStep = this.treeViewElem.find(".indent:first").width();

        allNodes.each(function () {
            let level = $(this).data("level");
            let indentWidth = indentStep * level;
            $(this).find(".indent")
                .css({
                    "width": indentWidth,
                    "min-width": indentWidth
                });
        });

        // expand selected nodes
        this.#expandSelectedNodes(allNodes);

        // do action or toggle on node click
        var thisObj = this;
        allNodes
            .off()
            .click(function (event) {
                if (event.ctrlKey || event.button == 1 /*middle*/) {
                    return true; // allow the default link behavior
                } else {
                    thisObj.#clickNode($(this));
                    return false;
                }
            });
    }
}
