name: Build .NET Applications and Capture Artifacts

on:
  push:
    branches: [develop]
  pull_request:
    branches: [develop]

jobs:
  build-and-upload-artifacts:
    runs-on: windows-latest

    steps:
      - name: Checkout Repository
        uses: actions/checkout@v2

      - name: Setup .NET Core
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: "6.0"

      # Restore NuGet packages for each project
      - name: Restore NuGet packages
        run: |
          dotnet restore ScadaCommon/ScadaCommon.sln
          dotnet restore ScadaAgent/ScadaAgent/ScadaAgent.sln
          dotnet restore ScadaComm/ScadaComm/ScadaComm.sln
          dotnet restore ScadaServer/ScadaServer/ScadaServer.sln
          dotnet restore ScadaWeb/ScadaWeb/ScadaWeb.sln
          dotnet restore ScadaAdmin/ScadaAdmin/ScadaAdmin.sln
          dotnet restore ScadaReport/ScadaReport.sln
          dotnet restore ScadaComm/OpenDrivers/OpenDrivers.sln
          dotnet restore ScadaComm/OpenDrivers2/OpenDrivers2.sln
          dotnet restore ScadaServer/OpenModules/OpenModules.sln
          dotnet restore ScadaWeb/OpenPlugins/OpenPlugins.sln
          dotnet restore ScadaAdmin/OpenExtensions/OpenExtensions.sln

      # Build each project
      - name: Build Projects
        run: |
          dotnet build --no-restore --configuration Release ScadaCommon/ScadaCommon.sln
          dotnet build --no-restore --configuration Release ScadaAgent/ScadaAgent/ScadaAgent.sln
          dotnet build --no-restore --configuration Release ScadaComm/ScadaComm/ScadaComm.sln
          dotnet build --no-restore --configuration Release ScadaServer/ScadaServer/ScadaServer.sln
          dotnet build --no-restore --configuration Release ScadaWeb/ScadaWeb/ScadaWeb.sln
          dotnet build --no-restore --configuration Release ScadaAdmin/ScadaAdmin/ScadaAdmin.sln
          dotnet build --no-restore --configuration Release ScadaReport/ScadaReport.sln
          dotnet build --no-restore --configuration Release ScadaComm/OpenDrivers/OpenDrivers.sln
          dotnet build --no-restore --configuration Release ScadaComm/OpenDrivers2/OpenDrivers2.sln
          dotnet build --no-restore --configuration Release ScadaServer/OpenModules/OpenModules.sln
          dotnet build --no-restore --configuration Release ScadaWeb/OpenPlugins/OpenPlugins.sln
          dotnet build --no-restore --configuration Release ScadaAdmin/OpenExtensions/OpenExtensions.sln

      # Publish each project
      - name: Publish Projects
        run: |
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaCommon ScadaCommon/ScadaCommon.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaAgent ScadaAgent/ScadaAgent/ScadaAgent.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaComm  ScadaComm/ScadaComm/ScadaComm.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaServer ScadaServer/ScadaServer/ScadaServer.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaWeb ScadaWeb/ScadaWeb/ScadaWeb.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaAdmin ScadaAdmin/ScadaAdmin/ScadaAdmin.sln
          dotnet publish --no-restore --configuration Release --output ./publish/ScadaReport ScadaReport/ScadaReport.sln
          dotnet publish --no-restore --configuration Release --output ./publish/OpenDrivers ScadaComm/OpenDrivers/OpenDrivers.sln
          dotnet publish --no-restore --configuration Release --output ./publish/OpenDrivers2 ScadaComm/OpenDrivers2/OpenDrivers2.sln
          dotnet publish --no-restore --configuration Release --output ./publish/OpenModules ScadaServer/OpenModules/OpenModules.sln
          dotnet publish --no-restore --configuration Release --output ./publish/OpenPlugins ScadaWeb/OpenPlugins/OpenPlugins.sln
      # dotnet publish --no-restore --configuration Release --output ./publish/OpenExtensions ScadaAdmin/OpenExtensions/OpenExtensions.sln

      # Prepare Artifacts Directory
      - name: Prepare Artifacts Directory
        run: |
          mkdir ./publish/artifacts
          mv ./publish/ScadaWeb/OpenPlugins/PlgSchShapeComp/wwwroot/SchShapeComp/js/*.js ./publish/artifacts/
          mv ./publish/ScadaWeb/OpenPlugins/PlgSchShapeComp/bin/Release/net6.0/** ./publish/artifacts/
          mv ./publish/ScadaWeb/ScadaWeb/bin/Release/net6.0/*.dll ./publish/artifacts/
          mv ./publish/ScadaWeb/ScadaWeb/bin/Release/net6.0/ScadaWeb.exe ./publish/artifacts/

      # Upload Artifacts
      - name: Upload Artifacts
        uses: actions/upload-artifact@v2
        with:
          name: bundled-artifacts
          path: ./publish/artifacts/**
